# Quantum Email Client - Testing Guide

## Quick Start

### 1. Start All Services
```bash
./test_integration.sh
```

This will start:
- QKD Simulator on port 8000
- Backend API on port 8001  
- Frontend Electron app on port 3000

Logs are written to `logs/` directory.

### 2. Stop All Services
```bash
./stop_services.sh
```

---

## Manual Testing

### Start Services Individually

#### QKD Simulator
```bash
cd qkd-simulator
python main.py
```
Access at: http://localhost:8000

#### Backend
```bash
cd backend
python -m uvicorn main:app --reload --host 0.0.0.0 --port 8001
```
Access at: http://localhost:8001
API docs: http://localhost:8001/docs

#### Frontend
```bash
cd quantum-mail-frontend
npm start
```
Electron app will open automatically.

---

## Testing Email Flow

### 1. Configure Email Credentials

**Important:** All credentials are configured in the **backend's `.env` file**, NOT in the frontend UI.

Edit `.env` file in the project root:
```env
# Gmail SMTP and IMAP (use App Password, not regular password)
SMTP_SERVER=smtp.gmail.com
SMTP_PORT=587
SMTP_USERNAME=your.email@gmail.com
SMTP_PASSWORD=your_app_password_here  # 16-character App Password

IMAP_SERVER=imap.gmail.com
IMAP_PORT=993
IMAP_USERNAME=your.email@gmail.com
IMAP_PASSWORD=your_app_password_here  # Same App Password as SMTP

# QKD Simulator (use 127.0.0.1 to avoid IPv6 connection issues)
QKD_KME_URL=http://127.0.0.1:8000
QKD_SOURCE_KME_ID=KME_001
QKD_TARGET_KME_ID=KME_002
QKD_KEY_SIZE=32
```

**Important Notes:**
- ⚠️ **Use Gmail App Password, NOT your regular Gmail password**
- The App Password is a special 16-character password generated by Google
- You need the same App Password for both SMTP (sending) and IMAP (receiving)
- The QKD simulator does NOT require any API keys or authentication
- The frontend just displays a welcome screen - it does NOT ask for credentials

**Get Gmail App Password:** 
1. Go to: https://myaccount.google.com/apppasswords
2. Generate an App Password for "Mail"
3. Use that 16-character password in the .env file (with or without spaces)
4. Save the .env file

**Frontend Login Screen:**
The frontend login screen is just a welcome/connection screen. It does NOT ask for credentials. All authentication is handled by the backend using the `.env` configuration.

### 2. Send Encrypted Email

In the frontend:
1. Click "Compose" button
2. Enter recipient email
3. Enter subject and body
4. Select security level:
   - **L1 (OTP)**: One-Time Pad - Maximum security, uses QKD keys
   - **L2 (AES-CFB)**: AES-256-CFB with QKD - Balanced security/performance (recommended)
   - **L3 (Kyber-512)**: Post-Quantum Cryptography - Future-resistant
   - **L4 (None)**: No encryption - For testing only
5. Click "Send"

### 3. Fetch Emails

1. Click "Inbox" or refresh button
2. Backend will fetch emails via IMAP
3. Encrypted emails will show with a security badge
4. Click on an encrypted email to automatically decrypt it

### 4. Verify Decryption

When you click an encrypted email:
- You should see "Decrypting..." with a spinner
- After 1-2 seconds, it shows "Decrypted" with a checkmark
- The email body should be readable plaintext
- Security banner shows the encryption level used

---

## API Testing

### Test QKD Simulator
```bash
# Get encryption keys
curl http://localhost:8000/api/v1/keys/enc_keys

# Get decryption keys  
curl http://localhost:8000/api/v1/keys/dec_keys
```

### Test Backend

#### Send Email
```bash
curl -X POST http://localhost:8001/send \
  -H "Content-Type: application/json" \
  -d '{
    "to": "recipient@example.com",
    "subject": "Test Email",
    "body": "This is a test",
    "security_level": 2
  }'
```

#### Fetch Emails
```bash
curl -X POST http://localhost:8001/fetch \
  -H "Content-Type: application/json" \
  -d '{
    "folder": "INBOX",
    "limit": 10
  }'
```

#### Decrypt Email
```bash
curl -X POST http://localhost:8001/decrypt \
  -H "Content-Type: application/json" \
  -d '{
    "encrypted_body": "ENCRYPTED:L2:...",
    "key_id": "key_12345"
  }'
```

---

## Frequently Asked Questions (FAQ)

### Q1: What password do I enter in the frontend?
**A:** The frontend **does not ask for any passwords**. The new simplified login screen is just a welcome screen that connects you to the backend. All email credentials (Gmail App Password) are configured in the backend's `.env` file.

### Q2: Should I use my regular Gmail password or App Password?
**A:** Always use the **Gmail App Password** (16-character code), NEVER your regular Google account password. App Passwords are more secure and specifically designed for applications like this.

### Q3: What is the API Key for the Quantum Key Manager?
**A:** The QKD simulator **does not have any API keys**. It's a simple REST API without authentication. The frontend previously had misleading fields asking for API keys, but those have been removed. The QKD simulator is accessed directly at `http://localhost:8000` with no authentication required.

### Q4: How do I get a Gmail App Password?
**A:**
1. Go to https://myaccount.google.com/apppasswords
2. Sign in to your Google account
3. Select "Mail" as the app
4. Select your device
5. Click "Generate"
6. Copy the 16-character password (you can remove spaces if you want)
7. Paste it into the `.env` file for both `SMTP_PASSWORD` and `IMAP_PASSWORD`

### Q5: Why doesn't the frontend ask for credentials?
**A:** This is a proper separation of concerns:
- **Backend** handles all authentication and encryption (configured via `.env`)
- **Frontend** is just a UI client that communicates with the backend via IPC
- This is more secure because credentials never leave the backend

### Q6: Can I use a different email provider like Outlook or Yahoo?
**A:** The backend is designed for Gmail, but you can modify the `SMTP_SERVER`, `SMTP_PORT`, `IMAP_SERVER`, and `IMAP_PORT` in the `.env` file to work with other providers. You'll need to find the SMTP/IMAP settings for your provider and ensure they support App Passwords or less secure apps.

---

## Troubleshooting

### QKD Simulator Not Starting
- Check if port 8000 is available: `lsof -i:8000`
- Check logs: `tail -f logs/qkd.log`

### Backend Not Starting  
- Check if port 8001 is available: `lsof -i:8001`
- Verify .env file exists with correct credentials
- Check logs: `tail -f logs/backend.log`

### Frontend Not Opening
- Check if port 3000 is available: `lsof -i:3000`
- Check logs: `tail -f logs/frontend.log`
- Try: `cd quantum-mail-frontend && npm start`

### Frontend Connection Errors (ECONNREFUSED ::1:8001)
**Symptom:** Frontend logs show `Error: connect ECONNREFUSED ::1:8001` when trying to send/fetch emails.

**Cause:** The frontend is trying to connect via IPv6 (`::1`) instead of IPv4 (`127.0.0.1`).

**Solution:** The code has been updated to use `127.0.0.1` instead of `localhost`:
- Frontend IPC handlers now use `http://127.0.0.1:8001`
- Backend QKD config now uses `http://127.0.0.1:8000`
- Update your `.env` file to use `127.0.0.1` if you set a custom URL

**To verify the fix:**
```bash
# Test backend connection (should return health status)
curl http://127.0.0.1:8001/health

# Test QKD simulator connection (should return keys list)
curl http://127.0.0.1:8000/api/v1/keys/enc_keys

# If curl works but frontend doesn't:
# 1. Stop the frontend (Ctrl+C)
# 2. Restart it: cd quantum-mail-frontend && npm start
```

**Note:** Backend must be started with `--host 0.0.0.0` to listen on all interfaces (this is already default in our scripts).

### Email Not Sending
- Verify Gmail App Password is correct (not regular password)
- Check backend logs for SMTP errors
- Ensure "Less secure app access" is NOT needed (App Passwords work without it)

### Email Not Decrypting
- Check that QKD simulator is running
- Verify key_ID in encrypted message matches available key
- Check browser console (Ctrl+Shift+I) for errors
- Ensure backend can reach QKD simulator at http://localhost:8000

### Emails Not Fetching
- Verify IMAP credentials in .env
- Check that IMAP is enabled in Gmail settings
- Ensure firewall allows port 993 (IMAP SSL)

---

## Expected Behavior

### Security Levels

#### L1 (OTP - One-Time Pad)
- Encrypted format: `ENCRYPTED:L1:[base64]:[key_id]`
- Maximum theoretical security
- Key size must equal message size
- Uses QKD keys directly

#### L2 (AES-CFB - Recommended)
- Encrypted format: `ENCRYPTED:L2:[base64_iv]:[base64_ciphertext]:[key_id]`
- AES-256-CFB with QKD-derived key
- Best performance/security balance
- Default choice for most users

#### L3 (Kyber-512 - Post-Quantum)
- Encrypted format: `ENCRYPTED:L3:[base64_kyber_ct]:[base64_aes_ct]:[base64_iv]`
- Hybrid: Kyber-512 + AES-256-CFB
- Independent of QKD
- Future-resistant against quantum attacks

#### L4 (None)
- No encryption
- Plaintext transmission
- For testing/compatibility only

### Visual Indicators

- **Lock icon**: Email is encrypted
- **Shield icon**: Security level indicator  
- **Green checkmark**: Successfully decrypted
- **Blue spinner**: Decryption in progress
- **Warning icon**: Potential security issue

---

## Development Tips

### Watch Backend Logs
```bash
tail -f logs/backend.log | grep -E "(ERROR|SUCCESS|decrypt)"
```

### Watch QKD Simulator Logs
```bash
tail -f logs/qkd.log
```

### Test Encryption Manually
```python
cd backend
python3
>>> from encryption import encrypt_message, decrypt_message
>>> encrypted = encrypt_message("Hello World", 2, "test_key_123")
>>> print(encrypted)
>>> decrypted = decrypt_message(encrypted, "test_key_data")
>>> print(decrypted)
```

### Check Email Headers
Encrypted emails include custom headers:
- `X-QuMail-Version: 1.0`
- `X-QuMail-Security-Level: L2`
- `X-QuMail-Key-ID: key_12345`

View in Gmail → Show original → Headers section

---

## Performance Benchmarks

| Security Level | Encryption Time | Decryption Time | Key Consumption |
|---------------|----------------|-----------------|-----------------|
| L1 (OTP)      | ~5ms           | ~5ms            | High (1:1)      |
| L2 (AES-CFB)  | ~2ms           | ~2ms            | Low (32 bytes)  |
| L3 (Kyber)    | ~15ms          | ~15ms           | None (PQC)      |
| L4 (None)     | 0ms            | 0ms             | None            |

*Measured on i5-8250U @ 1.6GHz*

---

## Next Steps

1. ✅ Basic email send/receive working
2. ✅ All encryption levels implemented
3. ✅ Auto-decryption on email open
4. ⏳ Attachment encryption (TODO)
5. ⏳ Key rotation policy (TODO)
6. ⏳ Multi-recipient support (TODO)
7. ⏳ Contact management (TODO)

---

## Security Notes

- **Never commit .env file** - Contains sensitive credentials
- **Use App Passwords** - Not regular Gmail passwords  
- **QKD Simulator** - For development only, not production-grade
- **Key Storage** - Currently in-memory, implement persistent storage for production
- **HTTPS** - Use TLS for all API calls in production

---

For more details, see:
- [AGENTS.md](AGENTS.md) - Architecture and requirements
- [README.md](README.md) - Project overview
- Backend API docs: http://localhost:8001/docs (when running)
